---
title: "Volumen Breakout Monitor"
output: 
    html_document:
        theme: readable
---

Dieses Projekt befindet sich ___Beta Stadium___ und ist somit ___in der Entwicklung___.  
Bekannte Bugs:  

- Bei Werten, deren Tickersymbol mit einer Zahl beginnt (bspw. 8GS.DE (China Spec Glass), wird ein "X" vorangestellt). Das verhindert bspw. das Plotten.


```Letzte Ausführung: `r Sys.time()` ```   

> NEWS 20. April 2015:  

- Es werden nunmehr eine Vielzahl deutscher Aktien eingelesen. Diese finden sich unter http://stooq.com/db/l/?g=29 Dennoch gibt es __nicht__ für alle diese Aktien entsprechende Volumendaten.
  
    
    
## Idee  

Die Idee ist folgende: Kreiere einen Report, der täglich (für das vorausgegangene Closing) ein Set an Aktien daraufhin monitored, ob es eine signifikante Veränderung im Handelsvolumen gegeben hat.

Der Indikator wird berechnet als Handelsvolumen am heutigen Tage $t$ dividiert durch das durschnittliche Handelsvolumen der letzten $k$ Tage. 

$$VB_{t}=\frac{Vol_{t}}{\frac{1}{k}\sum_{n=0}^{k-1}Vol_{t-n}}$$

Ein Signal wird bspw. dann generiert, wenn dieser Wert größer als _drei_ ist (was nichts anderes bedeutet, als dass das heutige Volumen dreimal größer als das durschnittliche Volumen ist).

## Implementierung

```{r load, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)


options("getSymbols.warning4.0"=FALSE)
suppressPackageStartupMessages(library(googleVis))
library(xts)
library(quantmod)
library(XML)
library(googleVis)
library(ggplot2)
library(reshape2)
library(bdscale)
library(RColorBrewer)

op <- options(gvis.plot.tag='chart')

xts2df <- function(x) {
  tmp <- data.frame(Date=index(x), coredata(x))
  return(tmp)
}


#http://stackoverflow.com/questions/24377590/getsymbols-downloading-data-for-multiple-symbols-and-calculate-returns

###############
# SET PARAMS
lookback <- 40
trigger <- 3
##############

# dax_url <- "http://finance.yahoo.com/q/cp?s=^GDAXI+Components"
# dax_tbl <- readHTMLTable(dax_url)
# dax_list <- as.character(dax_tbl$yfncsumtab$V1[6:35, drop=TRUE])
# mdax_url <- "http://finance.yahoo.com/q/cp?s=^MDAXI+Components"
# mdax_tbl <- readHTMLTable(mdax_url)
# mdax_list <- as.character(mdax_tbl$yfncsumtab$V1[6:55, drop=TRUE])
# sdax_url <- "http://finance.yahoo.com/q/cp?s=^SDAXI+Components"
# sdax_tbl <- readHTMLTable(sdax_url)
# sdax_list <- as.character(sdax_tbl$yfncsumtab$V1[6:55, drop=TRUE])
# tdax_url <- "http://finance.yahoo.com/q/cp?s=^TECDAX+Components"
# tdax_tbl <- readHTMLTable(tdax_url)
# tdax_list <- as.character(tdax_tbl$yfncsumtab$V1[6:35, drop=TRUE])
# de_stocks <- c(dax_list, mdax_list, sdax_list, tdax_list)

ticker <- read.csv(file="~/Desktop/tickerlist.csv")
ticker <- ticker[1:100,]
#remove <- c("HLE.DE", "TLG.DE")
#de_stocks <- de_stocks[!de_stocks%in%remove]
de_stocks <- as.character(ticker[-1,1])

StartDate <- as.Date("2015-01-01")
stocks <- new.env()

for (i in 1:length(de_stocks)) {
    try(
      getSymbols(de_stocks[i], from=StartDate, env=stocks, verbose = FALSE, warnings = FALSE)
      )
    Sys.sleep(3)
}
 
de_vol <- eapply(stocks, Vo)
de_vol <- as.xts(do.call(merge, de_vol))
# adjust column names are re-order columns
colnames(de_vol) <- gsub(".Volume","",colnames(de_vol))

de_vol[de_vol==0] <- NA # replace 0 with NA


de_vbt <- de_vol / (rollapply(de_vol, width=lookback, FUN=mean, na.rm=T, align="right"))
save(list=ls(all=TRUE), file="Volbreakout.RData")
#load(file="Volbreakout.RData")
```

### Werte

~~Zunächst ist das Monitoring für die Werte des DAX, MDAX, SDAX und TecDax umgesetzt.~~  
Eine Vielzahl deutscher Werte wird eingelesen, siehe Liste unter http://stooq.com/db/l/?g=29. Dennoch gibt es nicht für alle entsprechende Volumendaten.
Daten kommen von http://finance.yahoo.com.  

Ergebnisse des letzten Laufs:
```Eingelesene Werte: `r dim(de_vbt)[2]` ```  
```Letzter Close: `r end(de_vbt)` ```   

Werte, die __nicht__ eingelesen wurden (bspw. weil Yahoo keine Daten zur Verfügung gestellt hat, oder aber es einen Zugriffsfehler gab. Dient hier nur dem Cross-Check):  
``` `r setdiff(de_stocks, ls(envir=stocks))` ```

### Parameter

Für die Parametrierung wird k=`r lookback` gesetzt, d.h. auf die letzten `r lookback` Handelstage.


## Ergebnisse  

```{r last}
last <- t(tail(de_vbt,1))
last_stock <- rownames(last)[which(last>trigger)]
info <- if(is.null(last_stock)) {
  print("Keine Aktie hat ein Signal generiert")
  }   else { last_stock}
```

Die folgenden Aktien haben am vergangen Closing einen $VB$-Wert von über `r trigger` gezeigt (was einem Volumen über dem `r trigger`fachen Durchschnittsvolumen entspricht):  

````r info` ``` .

(_Leer_ bedeutet, dass kein Wert den Volumendurchschnitt 'durchbrochen' hat.)  

Für die gefundenen Werte werden die Charts dargestellt (natürlich nur, wenn für Werte ein Signal gefunden wurde).  

```{r charts}
for (i in 1:length(info)) {
  try(
    chartSeries(get(info[i], envir=stocks), subset='last 4 months', name=info[i]) 
    )
}
```
.  
.  
-----
  
Die Tabelle zeigt die VB-Werte für die letzten fünf Handelstage an; Klicken auf die Spaltenköpfe sortiert die Werte und man kann bspw. Werte über drei identifizieren.

```{r plot_tbl, results='asis'}
table <- data.frame(Share=names(tail(de_vbt,1)),          
                      t(tail(round(de_vbt,2),5)))
names(table)[-1] <- as.character(index(tail(de_vbt,5)))
Table <- gvisTable(table)
plot(Table)
```

Die Kürzel sind die Kürzel, die auf http://finance.yahoo.com verwendet werden.


```{r mosaicplot, eval=FALSE}
de_signal <- de_vbt["20150101::"]
de_signal <- ifelse(de_signal<trigger,FALSE,TRUE)
de_signal <- xts2df(de_signal)
de_signal <- melt(de_signal, id.vars="Date", variable.name="Stock", value.name="Signal")
ggplot(data=de_signal) + geom_tile(aes(x=Date, y=Stock, fill=Signal)) + scale_x_bd(business.dates=yahoo('^GDAXI')) +  scale_fill_brewer(palette="Paired") + theme_minimal() + ggtitle("Mosaikplot der VB-Signale") + coord_flip() + theme(axis.text.x=element_text(angle=90, vjust=0.5, hjust=1))# uses business days of DAX traded
```



# Nächste Schritte  

- Aktien, deren Ticker mit einer Zahl startet, werden hier mit einem "X" angeführt.


-----
```.`r Sys.time()` ```   

END OF FILE
