---
title: "Volumen Breakout Monitor"
output: 
    html_document:
        theme: readable
---

Dieses Projekt befindet sich ___Beta Stadium___ und ist somit ___in der Entwicklung___.

```Letzte Ausführung: `r Sys.time()` ```   


## Idee  

Die Idee ist folgende: Kreiere einen Report, der täglich (für das vorausgegangene Closing) ein Set an Aktien daraufhin monitored, ob es eine signifikante Veränderung im Handelsvolumen gegeben hat.

Der Indikator wird berechnet als Handelsvolumen am heutigen Tage $t$ dividiert durch das durschnittliche Handelsvolumen der letzten $k$ Tage. 

$$VB_{t}=\frac{Vol_{t}}{\frac{1}{k}\sum_{n=0}^{k-1}Vol_{t-n}}$$

Ein Signal wird bspw. dann generiert, wenn dieser Wert größer als _drei_ ist (was nichts anderes bedeutet, als dass das heutige Volumen dreimal größer als das durschnittliche Volumen ist).

## Implementierung

```{r load, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)


options("getSymbols.warning4.0"=FALSE)
suppressPackageStartupMessages(library(googleVis))
library(xts)
library(quantmod)
library(XML)
library(googleVis)
library(ggplot2)
library(reshape2)
library(bdscale)
library(RColorBrewer)

op <- options(gvis.plot.tag='chart')

xts2df <- function(x) {
  tmp <- data.frame(Date=index(x), coredata(x))
  return(tmp)
}


#http://stackoverflow.com/questions/24377590/getsymbols-downloading-data-for-multiple-symbols-and-calculate-returns

###############
# SET PARAMS
lookback <- 40
trigger <- 3
##############

dax_url <- "http://finance.yahoo.com/q/cp?s=^GDAXI+Components"
dax_tbl <- readHTMLTable(dax_url)
#str(tables$yfncsumtab$V1)
dax_list <- as.character(dax_tbl$yfncsumtab$V1[6:35, drop=TRUE])
mdax_url <- "http://finance.yahoo.com/q/cp?s=^MDAXI+Components"
mdax_tbl <- readHTMLTable(mdax_url)
mdax_list <- as.character(mdax_tbl$yfncsumtab$V1[6:55, drop=TRUE])
sdax_url <- "http://finance.yahoo.com/q/cp?s=^SDAXI+Components"
sdax_tbl <- readHTMLTable(sdax_url)
sdax_list <- as.character(sdax_tbl$yfncsumtab$V1[6:55, drop=TRUE])
tdax_url <- "http://finance.yahoo.com/q/cp?s=^TECDAX+Components"
tdax_tbl <- readHTMLTable(tdax_url)
tdax_list <- as.character(tdax_tbl$yfncsumtab$V1[6:35, drop=TRUE])

de_stocks <- c(dax_list, mdax_list, sdax_list, tdax_list)
remove <- c("HLE.DE", "TLG.DE")
de_stocks <- de_stocks[!de_stocks%in%remove]

  
StartDate <- as.Date("2013-01-01")
stocks <- new.env()
getSymbols(de_stocks, from=StartDate, env=stocks)

de_vol <- eapply(stocks, Vo)
de_vol <- as.xts(do.call(merge, de_vol))
# adjust column names are re-order columns
colnames(de_vol) <- gsub(".Volume","",colnames(de_vol))
de_vol[de_vol==0] <- NA # replace 0 with NA


de_vbt <- de_vol / (rollapply(de_vol, width=lookback, FUN=mean, na.rm=T, align="right"))


```


Zunächst ist das Monitoring für die 30 DAX Werte umgesetzt.  
Daten kommen von http://finance.yahoo.com.

Für die Parametrierung wird k=`r lookback` gesetzt, d.h. auf die letzten `r lookback` Handelstage.


## Ergebnisse  

```{r last}
last <- t(tail(de_vbt,1))
last_stock <- rownames(last)[which(last>trigger)]
info <- if(is.null(last_stock)) {
  print("Keine Aktien hat ein Signal generiert")
  }   else { last_stock}
```

Die folgenden Aktien haben am vergangen Closing einen $VB$-Wert von über `r trigger` gezeigt (was einem Volumen über dem `r trigger`fachen Durchschnittsvolumen entspricht):  
`r info`  .

(_Leer_ bedeutet, dass kein Wert den Volumendurchschnitt 'durchbrochen' hat.)  

Die Tabelle zeigt die VB-Werte für die letzten fünf Handelstage an; Klicken auf die Spaltenköpfe sortiert die Werte und man kann bspw. Werte über drei identifizieren.

```{r plot_tbl, results='asis'}
table <- data.frame(Share=names(tail(de_vbt,1)),          
                      t(tail(round(de_vbt,2),5)))
names(table)[-1] <- as.character(index(tail(de_vbt,5)))
Table <- gvisTable(table)
plot(Table)
```

Die Kürzel sind die Kürzel, die auf http://finance.yahoo.com verwendet werden.


Der Plot zeigt, wann ein Signal für eine jeweilige Aktie generiert wurde. Parameter sind wiederum k=`r lookback` Tage und das `r trigger`fache des Handelvolumens.

```{r mosaicplot}
de_signal <- de_vbt["20140701::"]
de_signal <- ifelse(de_signal<trigger,FALSE,TRUE)
de_signal <- xts2df(de_signal)
de_signal <- melt(de_signal, id.vars="Date", variable.name="Stock", value.name="Signal")
ggplot(data=de_signal) + geom_tile(aes(x=Date, y=Stock, fill=Signal)) + scale_x_bd(business.dates=yahoo('^GDAXI')) +  scale_fill_brewer(palette="Paired") + theme_minimal() + ggtitle("Mosaikplot der VB-Signale")# uses business days of DAX traded
```



# Nächste Schritte  

_Next Steps:_

- Füge weitere Aktien hinzu - MDAX und SDAX (?)
- füge Grafiken hinzu.
- Kürzel ersetzen mit richtigen Namen?

-----

END OF FILE
